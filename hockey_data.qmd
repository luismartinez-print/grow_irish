---
title: "ND Hockey Analysis"
format:
  html:
    toc: true
    toc-location: left
    self-contained: true
jupyter: python3
kernel: grow_irish
---
## READ IN 2025 DATA
```{python}
import requests
from bs4 import BeautifulSoup
import re
link = 'https://fightingirish.com/boxscore/444175/'

link_req = requests.get(link)
BeautifulSoup(link_req.content)
```

```{python}
headers = {
    'Referer':'https://fightingirish.com/sports/mhockey/schedule/',
    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/26.1 Safari/605.1.15'
}
response = requests.get(link, headers=headers)
soup = BeautifulSoup(response.text, 'html.parser')
iframe = soup.select('wmt-stats-iframe')
iframe_src = iframe[0].get('path')
iframe_src = re.search(r'\d+', iframe_src)[0]

source_link = f'https://api.wmt.games/api/statistics/games/{iframe_src}?with[0]=actions&with[1]=players&with[2]=plays&with[3]=drives&with[4]=penalties'

table_req = requests.get(source_link, headers=headers)
table_req.json()
```

```{python}
import requests
from bs4 import BeautifulSoup

schedule_url = "https://fightingirish.com/sports/mhockey/schedule/"

headers = {
    'Referer': schedule_url,
    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/26.1 Safari/605.1.15'
}

schedule_req = requests.get(schedule_url, headers=headers)
soup = BeautifulSoup(schedule_req.text, "html.parser")

links = soup.select("a[href*='/boxscore/']")
boxscore_urls = ["https://fightingirish.com" + x.get("href") for x in links]
boxscore_urls = [
    url.replace("https://fightingirish.comhttps://fightingirish.com",
                "https://fightingirish.com")
    for url in boxscore_urls
]

boxscore_urls[:10], len(boxscore_urls)
```

```{python}
def get_boxscore_json(boxscore_url):
    r = requests.get(boxscore_url, headers=headers)
    soup = BeautifulSoup(r.text, 'html.parser')

    iframe = soup.select('wmt-stats-iframe')
    iframe_src = iframe[0].get('path')
    game_id = re.search(r'\d+', iframe_src)[0]

    api_link = (
        f'https://api.wmt.games/api/statistics/games/{game_id}'
        '?with[0]=actions&with[1]=players&with[2]=plays&with[3]=drives&with[4]=penalties'
    )
    j = requests.get(api_link, headers=headers).json()
    j["source_url"] = boxscore_url
    return j
```

```{python}
all_games = []

for url in boxscore_urls:
    try:
        game_json = get_boxscore_json(url)
        game_json["source_url"] = url
        all_games.append(game_json)
        print(url)
    except Exception as e:
        print("FAILED:", url, e)
```

## PUT 2025 DATA IN DATAFRAME
```{python}
# full df with home games
import pandas as pd
rows = []

for game in all_games:
    game_id = game["data"]["id"]
    season = game["data"]['season_academic_year']
    date = game["data"]["game_date"]
    time_zone = game["data"]['local_time_zone']
    neutral_site = game["data"]['neutral_site']
    team1_home = game['data']['competitors'][0]['homeTeam']
    team2_home = game['data']['competitors'][1]['homeTeam']
    team1_name = game['data']['competitors'][0]['nameTabular']
    team2_name = game['data']['competitors'][1]['nameTabular']
    team1_score = game['data']['competitors'][0].get('score')
    team2_score = game['data']['competitors'][1].get('score')

    if team1_score is not None and team2_score is not None:
        win = team1_score > team2_score
    else:
        win = None 

    rows.append({
        "game_id": game_id,
        'season': season,
        "date": date,
        'time_zone': time_zone,
        'neutral': neutral_site,
        'team1_home': team1_home,
        'team2_home': team2_home,
        'team1_name': team1_name,
        'team2_name': team2_name,
        'team1_score': team1_score,
        'team2_score': team2_score,
        'win': win,
        "source_url": game["source_url"],
    })

df1 = pd.DataFrame(rows)
df1.head(15)
```

```{python}
# all nd away games
rows = []

for game in all_games:
    team1_name = game['data']['competitors'][0]['nameTabular']
    team1_home = game['data']['competitors'][0]['homeTeam']
    team1_score = game['data']['competitors'][0].get('score')
    team2_score = game['data']['competitors'][1].get('score')
    if team1_score is not None and team2_score is not None:
        win = team1_score > team2_score
    else:
        win = None 
    if team1_name == 'Notre Dame' and not team1_home:
        rows.append({
            "game_id": game["data"]["id"],
            'season': game["data"]['season_academic_year'],
            "date": game["data"]["game_date"],
            'time_zone': game["data"]['local_time_zone'],
            'neutral': game["data"]['neutral_site'],
            'team1_home': team1_home,
            'team2_home': game['data']['competitors'][1]['homeTeam'],
            'team1_name': team1_name,
            'team2_name': game['data']['competitors'][1]['nameTabular'],
            'team1_score': team1_score,
            'team2_score': team2_score,
            'win': win,
            "source_url": game["source_url"],
        })

df2 = pd.DataFrame(rows)
df2.head(15)
```

## READ IN 2024 DATA
```{python}
schedule2_url = "https://fightingirish.com/sports/mhockey/schedule/season/2024-25/"

headers2 = {
    'Referer': schedule2_url,
    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/26.1 Safari/605.1.15'
}

schedule2_req = requests.get(schedule2_url, headers=headers2)
soup2 = BeautifulSoup(schedule2_req.text, "html.parser")

links2 = soup2.select("a[href*='/boxscore/']")
boxscore2_urls = ["https://fightingirish.com" + x.get("href") for x in links2]
boxscore2_urls = [
    url2.replace("https://fightingirish.comhttps://fightingirish.com",
                "https://fightingirish.com")
    for url2 in boxscore2_urls
]

boxscore2_urls[:10], len(boxscore2_urls)
```

```{python}
def get_boxscore2_json(boxscore2_url):
    r2 = requests.get(boxscore2_url, headers=headers)
    soup2 = BeautifulSoup(r2.text, 'html.parser')

    iframe2 = soup2.select('wmt-stats-iframe')
    iframe2_src = iframe2[0].get('path')
    game2_id = re.search(r'\d+', iframe2_src)[0]

    api2_link = (
        f'https://api.wmt.games/api/statistics/games/{game2_id}'
        '?with[0]=actions&with[1]=players&with[2]=plays&with[3]=drives&with[4]=penalties'
    )
    j2 = requests.get(api2_link, headers=headers2).json()
    j2["source_url"] = boxscore2_url
    return j2
```

```{python}
all2_games = []

for url2 in boxscore2_urls:
    try:
        game2_json = get_boxscore2_json(url2)
        game2_json["source_url"] = url2
        all2_games.append(game2_json)
        print(url2)
    except Exception as e:
        print("FAILED:", url2, e)
```

## PUT 2024 DATA IN DATAFRAME
```{python}
# full df with home games
import pandas as pd
rows2 = []

for game2 in all2_games:
    game_id = game2["data"]["id"]
    season = game2["data"]['season_academic_year']
    date = game2["data"]["game_date"]
    time_zone = game2["data"]['local_time_zone']
    neutral_site = game2["data"]['neutral_site']
    team1_home = game2['data']['competitors'][0]['homeTeam']
    team2_home = game2['data']['competitors'][1]['homeTeam']
    team1_name = game2['data']['competitors'][0]['nameTabular']
    team2_name = game2['data']['competitors'][1]['nameTabular']
    team1_score = game2['data']['competitors'][0].get('score')
    team2_score = game2['data']['competitors'][1].get('score')

    if team1_score is not None and team2_score is not None:
        win = team1_score > team2_score
    else:
        win = None 

    rows2.append({
        "game_id": game_id,
        'season': season,
        "date": date,
        'time_zone': time_zone,
        'neutral': neutral_site,
        'team1_home': team1_home,
        'team2_home': team2_home,
        'team1_name': team1_name,
        'team2_name': team2_name,
        'team1_score': team1_score,
        'team2_score': team2_score,
        'win': win,
        "source_url": game2["source_url"],
    })

df3 = pd.DataFrame(rows2)
df3.head(15)
```

```{python}
# all nd away games
rows2 = []
for game2 in all2_games:
    team1_name = game2['data']['competitors'][0]['nameTabular']
    team1_home = game2['data']['competitors'][0]['homeTeam']
    if team1_name == 'Notre Dame' and not team1_home:
      game_id = game2["data"]["id"]
      season = game2["data"]['season_academic_year']
      date = game2["data"]["game_date"]
      time_zone = game2["data"]['local_time_zone']
      neutral_site = game2["data"]['neutral_site']
      team1_home = game2['data']['competitors'][0]['homeTeam']
      team2_home = game2['data']['competitors'][1]['homeTeam']
      team1_name = game2['data']['competitors'][0]['nameTabular']
      team2_name = game2['data']['competitors'][1]['nameTabular']
      team1_score = game2['data']['competitors'][0].get('score')
      team2_score = game2['data']['competitors'][1].get('score')

      if team1_score is not None and team2_score is not None:
          win = team1_score > team2_score
      else:
          win = None 

      rows2.append({
          "game_id": game_id,
          'season': season,
          "date": date,
          'time_zone': time_zone,
          'neutral': neutral_site,
          'team1_home': team1_home,
          'team2_home': team2_home,
          'team1_name': team1_name,
          'team2_name': team2_name,
          'team1_score': team1_score,
          'team2_score': team2_score,
          'win': win,
          "source_url": game2["source_url"],
      })
df4 = pd.DataFrame(rows2)
df4.head(20)
```

## COMBINE DATAFRAMES
```{python}
# all nd away games for both seasons
# clean date and time columns
combined = pd.concat([df2, df4], ignore_index=True)
combined['game_time_est'] = combined['date'].str.extract(r'T(.*)Z')
combined['date'] = combined['date'].str.replace(r'T(.*)$', '', regex=True)
combined
```

## ADD TRAVEL LOGISTICS DATA
```{python}
excel_path = '/Users/ashmarietta/Library/Mobile Documents/com~apple~CloudDocs/2025_fall_ndmsba/grow_irish/grow_irish/project_data.xlsx'
df_hockey = pd.read_excel(excel_path,sheet_name="Mens Hockey")
df_hockey_travel = df_hockey[
    df_hockey['location'].str.strip() != 'South Bend, IN'].copy()
```

```{python}
combined['team1_name']=combined['team1_name'].str.upper()
combined['team2_name']=combined['team2_name'].str.upper()
```

```{python}
combined['date'] = pd.to_datetime(combined['date']).dt.date
df_hockey_travel['travel_date'] = pd.to_datetime(df_hockey_travel['travel_date']).dt.date
df_hockey_travel['game_date'] = pd.to_datetime(df_hockey_travel['game_date']).dt.date
```

```{python}
overlap_cols = set(combined.columns).intersection(set(df_hockey_travel.columns))
df_hockey_travel_clean = df_hockey_travel.drop(columns=overlap_cols)

combined_merged = combined.merge(
    df_hockey_travel_clean,
    left_on=['date'],
    right_on=['game_date'],
    how='left'
)
combined = combined_merged.copy()
combined = combined.drop(columns=["com", 'opponent', "trip",'travel_time','connections','delay_red_eye','performance','competition_traveled'])
combined
```

## ADD TRAVEL STRESS DATA
```{python}
circadian_table = {
    "time_zones_crossed": {
        'EST': 0,
        'CST': 1,
        'GMT': 5,
        'MST': 2,
        "PST": 3,
        'PDT': 3,
        'PT': 3
    },
    "direction_bonus": {
        "East": 1,
        "West": 0
    }
}
```

```{python}
travel_load_table = {
    "total_distance": [
        (0, 150, 0),
        (150, 600, 1),
        (600, 1000, 2),
        (1000, float('inf'), 3)
    ],
    "duration": [
        (0, 180, 0),
        (180, 360, 1),
        (360, 540, 2),
        (540, float('inf'), 3)
    ]
}
```

```{python}
logistics_table = {
    "transport": {
        "Charter": 1,
        "Home": 0,
        "Bus": 1,
        "Commercial": 4
    }
}
```

```{python}
half_life_table = {
    "trip_score": [
        (0, 3, 0.35),
        (4, 8, 1.0),
        (9, 16, 1.5),
        (17, 25, 2.0),
        (26, float('inf'), 2.5)
    ]
}
```

## GENERATE INSIGHTS FROM TRAVEL STRESS DATA
```{python}
import numpy as np
def compute_circadian_score(df):
    df["tz_score"] = df["time_zones_crossed"].map(circadian_table["time_zones_crossed"]).fillna(0)

    df["direction_score"] = df["direction"].map(circadian_table["direction_bonus"]).fillna(0)

    df["circadian_score"] = df["tz_score"] + df["direction_score"]

    return df
```

```{python}
combined_test = compute_circadian_score(combined.copy())
print(combined_test[["time_zones_crossed", "direction", "tz_score", "direction_score", "circadian_score"]].head())
```

```{python}
def score_from_ranges(value, ranges):
    for low, high, score in ranges:
        if low <= value < high:
            return score
    return None

def compute_travel_load(df):
    df["duration_score"] = df["duration"].apply(
        lambda v: score_from_ranges(v, travel_load_table["duration"])
    )
    
    df["distance_score"] = df["total_distance"].apply(
        lambda v: score_from_ranges(v, travel_load_table["total_distance"])
    )

    df["travel_load_score"] = df["duration_score"] + df["distance_score"]

    return df
```

```{python}
combined_test = compute_travel_load(combined.copy())
print(combined_test[["duration", "total_distance", 
                     "duration_score", "distance_score", 
                     "travel_load_score"]].head())
```

```{python}
def compute_logistics_score(df):
    df["logistics_score"] = df["transport"].map(logistics_table["transport"]).fillna(0)
    return df
```

```{python}
def score_from_ranges(value, ranges):
    for low, high, score in ranges:
        if low <= value <= high:
            return score
    return None
```

```{python}
# circadian + travel_load + logistics
def compute_trip_score(df):
    df["trip_score"] = (
        df["circadian_score"]
        + df["travel_load_score"]
        + df["logistics_score"]
    )
    return df
```

```{python}
df_test = combined.copy()
df_test = compute_circadian_score(df_test)
df_test = compute_travel_load(df_test)
df_test = compute_logistics_score(df_test)
df_test = compute_trip_score(df_test)

print(df_test[["circadian_score", "travel_load_score", "logistics_score", "trip_score"]].head())
```

```{python}
df_stress = combined.copy()
df_stress = compute_circadian_score(df_stress)
df_stress = compute_travel_load(df_stress)
df_stress = compute_logistics_score(df_stress)
df_stress = compute_trip_score(df_stress)

stress_output = df_stress[[
    "circadian_score",
    "travel_load_score",
    "logistics_score",
    "trip_score"
]]

print(stress_output.head(20))
```

```{python}
# final dataframe
for col in stress_output.columns:
    combined[col] = df_stress[col]
combined
```
